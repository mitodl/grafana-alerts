namespace: heroku-logs
groups:
    - name: all-apps-general
      rules:
          - alert: InvalidAccessKeyProduction
            expr: 'sum by (application, environment) (count_over_time({environment=~".*production", application=~".+", application!="airbyte"} | json |= "InvalidAccessKeyId"[3h])) >= 1'
            for: 1m
            labels:
              severity: critical
            annotations:
                description: An invalid aws key has been detected in {{ $labels.application }} {{ $labels.environment }}.
          - alert: InvalidAccessKeyNonProd
            expr: 'sum by (application, environment) (count_over_time({environment!~".*production", application=~".+", application!="airbyte"} | json |= "InvalidAccessKeyId"[3h])) >= 1'
            for: 1m
            labels:
              severity: warning
            annotations:
                description: An invalid aws key has been detected in {{ $labels.application }} {{ $labels.environment }}.
          - alert: AlternateInvalidAccessKeyProduction
            expr: 'sum by(application, environment) (count_over_time({environment=~".*production", application=~".+", application!="airbyte"} |= "An error occurred (403) when calling the HeadObject operation: Forbidden" [3h])) >=1'
            for: 1m
            labels:
              severity: critical
            annotations:
                description: An invalid aws key has been detected in {{ $labels.application }} {{ $labels.environment }}.
          - alert: AlternateInvalidAccessKeyNonProd
            expr: 'sum by(application, environment) (count_over_time({environment!~".*production", application=~".+", application!="airbyte"} |= "An error occurred (403) when calling the HeadObject operation: Forbidden" [3h])) >=1'
            for: 1m
            labels:
              severity: warning
            annotations:
                description: An invalid aws key has been detected in {{ $labels.application }} {{ $labels.environment }}.
          - alert: BootcampsSAMLIntegrationErrorProd
            expr: 'sum by(application, environment) (count_over_time({environment=~".*production", application=~"bootcamp"} |= "Unable to refresh local metadata" [3h])) >=1'
            for: 1m
            labels:
              severity: critical
            annotations:
              description: The Bootcamps authentication integration with NovoEd is broken. This prevents learners from accessing courses.
          - alert: OCWStudio3PlayErrorDetectedNonProd
            expr: 'sum by (application, environment) (count_over_time({service="heroku", application="ocw-studio", environment!~".*production"} |= "3Play transcript request failed for video_id" [5m])) >= 1'
            for: 1m
            labels:
              severity: warning
              channel: notifications-ocw-misc
            annotations:
              description: A 3play transcript request has failed in NonProduction.
          - alert: OCWStudio3PlayErrorDetectedProd
            expr: 'sum by (application, environment) (count_over_time({service="heroku", application="ocw-studio", environment=~".*production"} |= "3Play transcript request failed for video_id" [5m])) >= 1'
            for: 1m
            labels:
              severity: warning
              channel: notifications-ocw-misc
            annotations:
              description: A 3play transcript request has failed in Production.
